# 0_イントロダクション

<p style='text-align: right;'> &copy; 20220112 by Takanori Shima </p>

## 1. EC2 の紹介

AWSは `Amazon Web Service`の略で Amazonが提供するクラウドコンピューティング環境である。

似たようなサービスにAzure(Microsoft)やGoogle Cloud(Google)もあるが、AWSはその中でも高いシェアを誇り、圧倒的な人気を持っている。

もともとは Amazon社内で使っていた社内システムに起源をもつ。

`EC2`とは、Amazon Web Service が提供している仮想サーバー構築サービス。

`Elastic Compute Cloud`の略で日本語に直すと、`柔軟に構築できるコンピュータクラウド環境`のこと。

これまでデータセンターで物理的なサーバーの構築を行っていたのが、Web上から数クリックで仮想サーバーを構築することができるので、業務の効率化を達成することができる。

また、継続利用時に起こりがちなスペック不足やディスク容量問題への対処も容易なコンピューティングキャパシティーであるため、長期的な運用も視野に入れることができる。

仮想サーバは `インスタンス`という単位で起動することでできる。 

インスタンスを最初の使う時には、初期設定で使用するOSとして Linux/Windows/MacOSなどを選択することができるが、無料枠で使用できるのは Amazon Linux2 のみ。

自由なソフトをインストールすることができ、アプリをデプロイしてインターネットに公開することができる。

EC2インスタンス環境にアクセスするには　SSHキーを利用する。

EC2の代表的なメリットは以下の通り。

```
1. 構築にかかる時間が短縮できる
2. 冗長化が簡単にできる
3. スペックの変更が柔軟に対応できる（Elastic）
4. 関連するサービスがたくさん存在するため、それらを組み合わせてカスタマイズのバラエティが広い
5. ネット情報などのリソースが多い
```

EC2の料金体系
```
- オンデマンドインスタンス
　　サーバーを立ち上げている時間によって料金が発生する
- リザーブドインスタンス
　　あらかじめ稼働期間を決めておき、先支払いする
- スポットインスタンス
　　AWS上にすでに存在し放置されているインスタンスを格安利用料で使う
```

EC2の関連サービス
```
- イメージ
　　サーバーのイメージを保管しておく
- EBS（Elastic Block Store）
    サーバー上に保存したデータを保管しておく
- Elastic IP
    固定IPを作成する
- Route 53
    固定IPにドメインを紐づける
- ロードバランンシング
    負荷分散
```
など

## 2. EC2での環境構築手順

```
1. EC2インスタンスの起動
2. SSHキーペア（秘密鍵、公開鍵）が自動作成される
3. ローカル環境から 秘密鍵を使って SSH接続してEC2インスタンスの中に入り込む
4. PHP/MySQL/Apach/Git/SSH/Conposerなどのソフトをインストールする
5. PEM形式のSSHキーペアを新規作成
6. GithubのDeployキーに新しく作成した公開鍵を登録
7. Githubリポジトリからアプリをcloneする
8. Apacheの設定変更
9. Laravelアプリの環境設定
10. アプリケーションキーの設定
11. マイグレーション
12. ブラウザからHTTPアクセス
```

## 3. CircleCIからEC2へ自動デプロイする手順
```
1. 新しく作った秘密鍵をCircleCIのSSHキーに登録
2. .circleci/.config.yml ファイルの編集
3. 環境変数の登録
4. Githubへpush
```

## 4. Elastic IP を使ってEC2インスタンスに固定IPを付与

以下のサイトを参考にする

https://qiita.com/Jerid/items/d5dd3a29ed9a0e374493

手順)
```
1. 「EC2」より、「Elastic IP」を選択し、右上の「Elastic IPアドレスの割り当て」を選択。デフォルトで割り当て実行
2. 「アクション」から「Elastic IPの関連付け」を選択。「インスタンス」には、Elastic IPを付与したいインスタンスを、
「プライベートIPアドレス」にはそのインスタンスのプライベートIPを選択。
```

## 5. Route 53を使って、固定IPにドメインの割り付け

以下のサイトを参考にする

https://avinton.com/academy/route53-dns-vhost/

注）ホストゾーン1つにつき毎月0.5ドルの料金が発生するため、継続して利用しない場合は設定を削除する

手順)
```
1. Route 53の管理画面に行きDNSのダッシュボード選択
2. DNS管理のホストゾーン作成ボタンをクリックする
3. 以下を設定
    - ドメイン名: 関連付けたいホスト名。お名前.comなど別途サービスであらかじめ取得しておく
    - タイプは　パブリックホストゾーンを選択
4. ホストゾーンの作成を押す
5. レコードを作成ボタンを押す
6. 値の箇所に、先ほどEC2に関連付けた固定IPを入力しレコード作成ボタンを押す
7. お名前.comなどの別途サービスのサイトにログインし、DNSの設定を行う
    - AWS Route 53 で設定したDNSの設定を最低2つは行う
```

公開されたサイト例）

http://quark2galaxy.com/

## 6. Certificate Managerを使ったサイトのSSL化

AWSはSSL証明書が無料で発行できる

以下を参考にする

https://aws.taf-jp.com/blog/37623

```
1. AWS の Certificate Managerの管理画面へいく
2. 証明書をリクエスト　ボタンを押す
3. パブリック証明書のリクエスト を選んで　次へ
4. webサイトで利用予定のドメインを指定して 他の設定はデフォルトのまま　「リクエスト発行」ボタンを押す
5. Route 53 でのレコードの作成をクリック
6. 以下間に合わず ... 
7. ロードバランサ系の設定も必要っぽい
```
